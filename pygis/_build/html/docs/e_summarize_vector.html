
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta content="Learn how to aggregate geospatial data to identify areas of high and low concentration." lang="en" name="description" xml:lang="en" />
<meta content="geospatial, aggregate, summarize, binning, vector, shapefile" name="keywords" />
<meta content="en_US" property="og:locale" />

    <title>Summary Operations to Depict Concentrations &#8212; Open Source Geospatial Programming &amp; Remote Sensing</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://mmann1123.github.io/pyGIS/docs/e_summarize_vector.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Merge Data &amp; Dissolve Polygons" href="e_vector_merge_dissolve.html" />
    <link rel="prev" title="Extraction" href="e_extraction.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/pygis.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Open Source Geospatial Programming & Remote Sensing</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="a_intro.html">
   PyGIS
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Get Started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="b_intro_py.html">
   Welcome - Let’s get started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b_about_py.html">
   Getting Started in Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b_getting_started.html">
   Setting up Your Python Environment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b_python_by_example.html">
   An Introductory Example
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b_learn_more.html">
   Learn More
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Data Types
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="c_features.html">
   Geospatial Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="c_store_features.html">
   Data Storage Formats
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="c_vectors.html">
   Geospatial Vector Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="c_rasters.html">
   Geospatial Raster Data
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Nature of Coordinate Systems
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="d_crs_what_is_it.html">
   What is a CRS?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="d_understand_crs_codes.html">
   Understanding CRS codes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="d_affine.html">
   Affine Transforms
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="d_vector_crs_intro.html">
   Vector Coordinate Reference Systems (CRS)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="d_raster_crs_intro.html">
   Raster Coodinate Reference Systems (CRS)
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Basic Operations
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="e_vector_op_intro.html">
   Vector Operations
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="e_attributes.html">
     Attributes &amp; Indexing for Vector Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="e_new_vectors.html">
     Creating Geospatial Vector Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="e_vector_overlay.html">
     Vector Overlays and Joins
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="e_extraction.html">
     Extraction
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Summary Operations to Depict Concentrations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="e_vector_merge_dissolve.html">
     Merge Data &amp; Dissolve Polygons
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="e_raster_op_intro.html">
   Raster Operations
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="e_raster_reproject.html">
     Reproject Rasters
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Remote Sensing
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="f_rs_intro.html">
   Remote Sensing with Python using Geowombat
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="f_rs_io.html">
     Opening Remote Sensed Images
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="f_rs_edit.html">
     Editing Rasters and Remotely Sensed Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="f_rs_plot.html">
     Plot Remote Sensed Images
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="f_rs_crs.html">
     Remote Sensing Coordinate Reference Systems
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="f_rs_mosaic.html">
     Handle Multiple Remotely Sensed Images
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="f_rs_config.html">
     Configuration manager
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="f_rs_band_math.html">
     Band Math &amp; Vegetation Indices
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="f_rs_extraction.html">
     Raster Data Extraction
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../_sources/docs/e_summarize_vector.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/docs/e_summarize_vector.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/mmann1123/pyGIS"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/mmann1123/pyGIS/issues/new?title=Issue%20on%20page%20%2Fdocs/e_summarize_vector.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/mmann1123/pyGIS/edit/main/./pygis/docs/e_summarize_vector.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/mmann1123/pyGIS/main?urlpath=tree/./pygis/docs/e_summarize_vector.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summarize-by-grid">
   Summarize by Grid
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#method-1-group-by">
     Method 1 - Group by
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#method-2-iterate-through-each-feature">
     Method 2 - Iterate through each feature
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#kernel-density-estimation">
   Kernel Density Estimation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#method-1-display">
     Method 1 - Display
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#method-2-display-and-export-with-scipy">
     Method 2 - Display and export with
     <code class="docutils literal notranslate">
      <span class="pre">
       scipy
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#method-3-display-and-export-with-scikit-learn">
     Method 3 - Display and export with
     <code class="docutils literal notranslate">
      <span class="pre">
       scikit-learn
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Create a grid to bin features</p></li>
<li><p>Bin features using the grid</p></li>
<li><p>Display kernel density estimation results and export resulting raster</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="c_vectors.html"><span class="doc std std-doc">Geospatial Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="c_rasters.html"><span class="doc std std-doc">Geospatial Raster Data</span></a></p></li>
<li><p><a class="reference internal" href="e_attributes.html"><span class="doc std std-doc">Attributes &amp; Indexing for Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="e_new_vectors.html"><span class="doc std std-doc">Creating Geospatial Vector Data</span></a></p></li>
</ul>
</div>
<div class="section" id="summary-operations-to-depict-concentrations">
<h1>Summary Operations to Depict Concentrations<a class="headerlink" href="#summary-operations-to-depict-concentrations" title="Permalink to this headline">¶</a></h1>
<p>Summary operations are useful for aggregating data, whether it be for analyzing overall trends or visualizing concentrations of data. Summarizing allows for effective analysis and communication of the data as compared to simply looking at or displaying points, lines, and polygons on a map.</p>
<p>This chapter will explore two summary operations that highlight concentrations of data: summarize by grid (count points in a grid) and kernel density.</p>
<div class="section" id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>First, we will import the necessary modules.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import modules</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">box</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">geoplot</span> <span class="k">as</span> <span class="nn">gplt</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.transform</span> <span class="kn">import</span> <span class="n">Affine</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">fetch_species_distributions</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KernelDensity</span>
</pre></div>
</div>
</div>
</div>
<p>We will utilize shapefiles of San Francisco Bay Area county boundaries and wells within the Bay Area and the surrounding 50 km. We will load in the data and reproject the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load data</span>

<span class="c1"># County boundaries</span>
<span class="c1"># Source: https://opendata.mtc.ca.gov/datasets/san-francisco-bay-region-counties-clipped?geometry=-125.590%2C37.123%2C-119.152%2C38.640</span>
<span class="n">counties</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../_static/e_vector_shapefiles/sf_bay_counties/sf_bay_counties.shp&quot;</span><span class="p">)</span>

<span class="c1"># Well locations</span>
<span class="c1"># Source: https://gis.data.ca.gov/datasets/3a3e681b894644a9a95f9815aeeeb57f_0?geometry=-123.143%2C36.405%2C-119.230%2C37.175</span>
<span class="c1"># Modified by author so that only the well locations within the counties and the surrounding 50 km were kept</span>
<span class="n">wells</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../_static/e_vector_shapefiles/sf_bay_wells_50km/sf_bay_wells_50km.shp&quot;</span><span class="p">)</span>

<span class="c1"># Reproject data to NAD83(HARN) / California Zone 3</span>
<span class="c1"># https://spatialreference.org/ref/epsg/2768/</span>
<span class="n">proj</span> <span class="o">=</span> <span class="mi">2768</span>
<span class="n">counties</span> <span class="o">=</span> <span class="n">counties</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
<span class="n">wells</span> <span class="o">=</span> <span class="n">wells</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>

<span class="c1"># Create a column that assigns each well a number</span>
<span class="n">wells</span><span class="p">[</span><span class="s2">&quot;Well_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">wells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="summarize-by-grid">
<h2>Summarize by Grid<a class="headerlink" href="#summarize-by-grid" title="Permalink to this headline">¶</a></h2>
<p>To summarize by grid, we create a new polygon layer consisting of a grid and overlay on another feature. We can summarize an aspect of that feature within each cell of the grid. The polygon layer commonly consists of a fishnet (rectangular cells), but using hexagons as a grid is becoming increasingly widespread.</p>
<p>Let’s define a function that will create a grid of either rectangles or hexagons of a specified side length.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_grid</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">side_length</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a grid consisting of either rectangles or hexagons with a specified side length that covers the extent of input feature.&#39;&#39;&#39;</span>

    <span class="c1"># Get extent of input feature</span>
    <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">total_bounds</span>

    <span class="c1"># Slightly displace the minimum and maximum values of the feature extent</span>
    <span class="c1"># This decreases likelihood that a feature will fall directly on a cell boundary (in between two cells)</span>
    <span class="n">min_x</span> <span class="o">-=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_x</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0005</span>
    <span class="n">min_y</span> <span class="o">-=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">min_y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0005</span>
    <span class="n">max_x</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_x</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0005</span>
    <span class="n">max_y</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0005</span>

    <span class="c1"># Create empty list to hold individual cells that will make up the grid</span>
    <span class="n">cells_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Create grid of squares if specified</span>
    <span class="k">if</span> <span class="n">shape</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;square&quot;</span><span class="p">,</span> <span class="s2">&quot;rectangle&quot;</span><span class="p">,</span> <span class="s2">&quot;box&quot;</span><span class="p">]:</span>

        <span class="c1"># Adapted from https://james-brennan.github.io/posts/fast_gridding_geopandas/</span>
        <span class="c1"># Create and iterate through list of x values that will define column positions with specified side length</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_x</span> <span class="o">-</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">side_length</span><span class="p">):</span>

            <span class="c1"># Create and iterate through list of y values that will define row positions with specified side length</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_y</span> <span class="o">-</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">side_length</span><span class="p">):</span>

                <span class="c1"># Create a box with specified side length and append to list</span>
                <span class="n">cells_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">side_length</span><span class="p">))</span>


    <span class="c1"># Otherwise, create grid of hexagons</span>
    <span class="k">elif</span> <span class="n">shape</span> <span class="o">==</span> <span class="s2">&quot;hexagon&quot;</span><span class="p">:</span>

        <span class="c1"># Set horizontal displacement that will define column positions with specified side length (based on normal hexagon)</span>
        <span class="n">x_step</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">side_length</span>

        <span class="c1"># Set vertical displacement that will define row positions with specified side length (based on normal hexagon)</span>
        <span class="c1"># This is the distance between the centers of two hexagons stacked on top of each other (vertically)</span>
        <span class="n">y_step</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">side_length</span>

        <span class="c1"># Get apothem (distance between center and midpoint of a side, based on normal hexagon)</span>
        <span class="n">apothem</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">side_length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Set column number</span>
        <span class="n">column_number</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Create and iterate through list of x values that will define column positions with vertical displacement</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">+</span> <span class="n">x_step</span><span class="p">,</span> <span class="n">x_step</span><span class="p">):</span>

            <span class="c1"># Create and iterate through list of y values that will define column positions with horizontal displacement</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">+</span> <span class="n">y_step</span><span class="p">,</span> <span class="n">y_step</span><span class="p">):</span>

                <span class="c1"># Create hexagon with specified side length</span>
                <span class="n">hexagon</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span> <span class="o">*</span> <span class="n">side_length</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">angle</span><span class="p">))</span> <span class="o">*</span> <span class="n">side_length</span><span class="p">]</span> <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="mi">60</span><span class="p">)]</span>

                <span class="c1"># Append hexagon to list</span>
                <span class="n">cells_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Polygon</span><span class="p">(</span><span class="n">hexagon</span><span class="p">))</span>

            <span class="c1"># Check if column number is even</span>
            <span class="k">if</span> <span class="n">column_number</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                <span class="c1"># If even, expand minimum and maximum y values by apothem value to vertically displace next row</span>
                <span class="c1"># Expand values so as to not miss any features near the feature extent</span>
                <span class="n">min_y</span> <span class="o">-=</span> <span class="n">apothem</span>
                <span class="n">max_y</span> <span class="o">+=</span> <span class="n">apothem</span>

            <span class="c1"># Else, odd</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># Revert minimum and maximum y values back to original</span>
                <span class="n">min_y</span> <span class="o">+=</span> <span class="n">apothem</span>
                <span class="n">max_y</span> <span class="o">-=</span> <span class="n">apothem</span>

            <span class="c1"># Increase column number by 1</span>
            <span class="n">column_number</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Else, raise error</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Specify a rectangle or hexagon as the grid shape.&quot;</span><span class="p">)</span>

    <span class="c1"># Create grid from list of cells</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">cells_list</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">)</span>

    <span class="c1"># Create a column that assigns each grid a number</span>
    <span class="n">grid</span><span class="p">[</span><span class="s2">&quot;Grid_ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">))</span>

    <span class="c1"># Return grid</span>
    <span class="k">return</span> <span class="n">grid</span>
</pre></div>
</div>
</div>
</div>
<p>We will illustrate this methodology by counting the number of well points within each cell of the grid. There are two different ways we can accomplish this methodology, both with advantages and disadvantages.</p>
<p>To begin, we will set some global parameters for both examples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set side length for cells in grid</span>
<span class="c1"># This is dependent on projection chosen as length is in units specified in projection</span>
<span class="n">side_length</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="c1"># Set shape of grid</span>
<span class="n">shape</span> <span class="o">=</span> <span class="s2">&quot;hexagon&quot;</span>
<span class="c1"># shape = &quot;rectangle&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="method-1-group-by">
<h3>Method 1 - Group by<a class="headerlink" href="#method-1-group-by" title="Permalink to this headline">¶</a></h3>
<p>This method involves using spatial joins to allocate each point to the cell in which it resides. All the points within each cell are subsequently grouped together and counted.</p>
<p>First, we will create a grid over the Bay Area.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create grid</span>
<span class="n">bay_area_grid</span> <span class="o">=</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">feature</span> <span class="o">=</span> <span class="n">wells</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">,</span> <span class="n">side_length</span> <span class="o">=</span> <span class="n">side_length</span><span class="p">)</span>

<span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot data</span>
<span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;bisque&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">wells</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">bay_area_grid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;lightseagreen&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.55</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - Boundaries, Wells, and Grids&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we will conduct a spatial join for each well point, essentially assigning it to a cell. We can add a field with a value of <code class="docutils literal notranslate"><span class="pre">1</span></code>, group all the wells in a cell, and aggregate all those <code class="docutils literal notranslate"><span class="pre">1</span></code> values to get the total number of wells in a cell.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform spatial join, merging attribute table of wells point and that of the cell with which it intersects</span>
<span class="c1"># op = &quot;intersects&quot; also counts those that fall on a cell boundary (between two cells)</span>
<span class="c1"># op = &quot;within&quot; will not count those fall on a cell boundary</span>
<span class="n">wells_cell</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">wells</span><span class="p">,</span> <span class="n">bay_area_grid</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="s2">&quot;intersects&quot;</span><span class="p">)</span>

<span class="c1"># Remove duplicate counts</span>
<span class="c1"># With intersect, those that fall on a boundary will be allocated to all cells that share that boundary</span>
<span class="n">wells_cell</span> <span class="o">=</span> <span class="n">wells_cell</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Well_ID&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Set field name to hold count value</span>
<span class="n">count_field</span> <span class="o">=</span> <span class="s2">&quot;Count&quot;</span>

<span class="c1"># Add a field with constant value of 1</span>
<span class="n">wells_cell</span><span class="p">[</span><span class="n">count_field</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Group GeoDataFrame by cell while aggregating the Count values</span>
<span class="n">wells_cell</span> <span class="o">=</span> <span class="n">wells_cell</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Grid_ID&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="n">count_field</span><span class="p">:</span><span class="s1">&#39;sum&#39;</span><span class="p">})</span>

<span class="c1"># Merge the resulting grouped dataframe with the grid GeoDataFrame, using a left join to keep all cell polygons</span>
<span class="n">bay_area_grid</span> <span class="o">=</span> <span class="n">bay_area_grid</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">wells_cell</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="s1">&#39;Grid_ID&#39;</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">)</span>

<span class="c1"># Fill the NaN values (cells without any points) with 0</span>
<span class="n">bay_area_grid</span><span class="p">[</span><span class="n">count_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">bay_area_grid</span><span class="p">[</span><span class="n">count_field</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Convert Count field to integer</span>
<span class="n">bay_area_grid</span><span class="p">[</span><span class="n">count_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">bay_area_grid</span><span class="p">[</span><span class="n">count_field</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Display grid attribute table</span>
<span class="n">display</span><span class="p">(</span><span class="n">bay_area_grid</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can plot the data to see how it looks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot data</span>
<span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">wells</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">bay_area_grid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="s2">&quot;Count&quot;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;RdPu&quot;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;lightseagreen&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.70</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - Binning Well Points&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>The advantage of this method is that it is pretty fast. To verify that all points have been counted once, we can check the aggregate of all the point sums for each cell.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check total number of well points counted and compare to number of well points in input data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total number of well points counted: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Number of well points in input data: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">bay_area_grid</span><span class="o">.</span><span class="n">Count</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">wells</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="method-2-iterate-through-each-feature">
<h3>Method 2 - Iterate through each feature<a class="headerlink" href="#method-2-iterate-through-each-feature" title="Permalink to this headline">¶</a></h3>
<p>This second method is slightly more intuitive, but it can take a long time to run. We will use a subset of the input data–those that fall within Santa Clara County–to illustrate this example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select the Santa Clara County boundary</span>
<span class="n">sc_county</span> <span class="o">=</span> <span class="n">counties</span><span class="p">[</span><span class="n">counties</span><span class="p">[</span><span class="s2">&quot;coname&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Santa Clara County&quot;</span><span class="p">]</span>

<span class="c1"># Multiply the boundary dataset by the number of rows in the wells dataset, and concatenate all the boundary datasets together into one dataframe</span>
<span class="n">sc_county_replicate_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">sc_county</span><span class="p">]</span> <span class="o">*</span> <span class="n">wells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ignore_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Create a GeoDataFrame from the county dataframe</span>
<span class="n">sc_county_replicate_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">sc_county_replicate_df</span><span class="p">)</span>

<span class="c1"># Subset the GeoDataFrame by checking which wells are within Santa Clara County</span>
<span class="n">sc_county_wells</span> <span class="o">=</span> <span class="n">wells</span><span class="p">[</span><span class="n">wells</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">sc_county_replicate_gdf</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>First, we will create a grid over Santa Clara County.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create grid</span>
<span class="n">sc_county_grid</span> <span class="o">=</span> <span class="n">create_grid</span><span class="p">(</span><span class="n">feature</span> <span class="o">=</span> <span class="n">sc_county_wells</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">,</span> <span class="n">side_length</span> <span class="o">=</span> <span class="n">side_length</span><span class="p">)</span>

<span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot data</span>
<span class="n">sc_county</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;bisque&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">sc_county_wells</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">sc_county_grid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;lightseagreen&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.55</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Santa Clara County - Boundaries, Wells, and Grids&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>We iterate through each cell in the grid and set a counter for each cell. We iterate through each well point and see if it is within (or intersects) the cell. If it is, the counter is increased by 1, and the feature is “discarded” so that it won’t be counted again (resolving the issue of a point falling on the boundary between two cells).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create empty list used to hold count values for each grid</span>
<span class="n">counts_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Create empty list to hold index of points that have already been matched to a grid</span>
<span class="n">counted_points</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Iterate through each cell in grid</span>
<span class="k">for</span> <span class="n">i_1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sc_county_grid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

    <span class="c1"># Get a cell by index</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">sc_county_grid</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">i_1</span><span class="p">]]</span>

    <span class="c1"># Reset index of cell to 0</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Set point count to 0</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Iterate through each feature in wells dataset</span>
    <span class="k">for</span> <span class="n">i_2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sc_county_wells</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>

        <span class="c1"># Check if index of point is in list of indices whose points have already been matched to a grid and counted</span>
        <span class="k">if</span> <span class="n">i_2</span> <span class="ow">in</span> <span class="n">counted_points</span><span class="p">:</span>

            <span class="c1"># If already counted, skip remaining statements in loop and start at top of loop</span>
            <span class="k">continue</span>

        <span class="c1"># Otherwise, continue with remaining statements</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Get a well point by index</span>
        <span class="n">well</span> <span class="o">=</span> <span class="n">sc_county_wells</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">i_2</span><span class="p">]]</span>

        <span class="c1"># Reset index of well point (to 0) to match the index-reset cell</span>
        <span class="n">well</span> <span class="o">=</span> <span class="n">well</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check if well intersects the cell</span>
        <span class="c1"># Best to use intersects instead of within or contains, as intersect will count points that fall exactly on the cell boundaries</span>
        <span class="c1"># Points that fall exactly on a cell boundary (between two cells) will be allocated to the first of the two cells called in script</span>
        <span class="n">criteria_met</span> <span class="o">=</span> <span class="n">well</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">cell</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># If preferred, can check if well is within cell or if cell contains well</span>
        <span class="c1"># Both statements do the same thing</span>
        <span class="c1"># criteria_met = well.within(cell)[0]</span>
        <span class="c1"># criteria_met = cell.contains(well)[0]</span>

        <span class="c1"># Check if criteria has been met (True)</span>
        <span class="k">if</span> <span class="n">criteria_met</span><span class="p">:</span>

            <span class="c1"># If True, increase counter by 1 for the cell</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># Add index of counted point to the list</span>
            <span class="n">counted_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_2</span><span class="p">)</span>

        <span class="c1"># Otherwise, criteria is not met (False)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># Add total count for that cell to the list of counts</span>
    <span class="n">counts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

<span class="c1"># print(counts_list)</span>

<span class="c1"># Add a new column to the grid GeoDataFrame with the list of counts for each cell</span>
<span class="n">sc_county_grid</span><span class="p">[</span><span class="s1">&#39;Count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">counts_list</span><span class="p">)</span>

<span class="c1"># Display grid attribute table</span>
<span class="n">display</span><span class="p">(</span><span class="n">sc_county_grid</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can check to make sure all well points in Santa Clara County were counted.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check total number of well points counted and compare to number of well points in input data</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total number of well points counted: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Number of well points in input data: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sc_county_wells</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we can plot the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot data</span>
<span class="n">sc_county</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">sc_county_wells</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">sc_county_grid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="s2">&quot;Count&quot;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;RdPu&quot;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;lightseagreen&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.70</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Santa Clara County - Binning Well Points&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="kernel-density-estimation">
<h2>Kernel Density Estimation<a class="headerlink" href="#kernel-density-estimation" title="Permalink to this headline">¶</a></h2>
<p>Kernel density estimation (KDE) uses a specified kernel function to visualize the density of points or polylines. For more information on KDE, check out <a class="reference external" href="https://mathisonian.github.io/kde/">this visualization</a>.</p>
<p>We will demonstrate three ways to perform kernel density estimation. The first way allows us to quickly visualize the KDE. The second and third ways also allow us to export and save a KDE raster for additional analysis.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>We are intentionally keeping the well points beyond (but within 50 km) of the Bay Area boundaries. This provides a buffer to ensure that the KDE for wells data near the boundaries is not inadvertently influenced by these artificial county boundaries. Once KDE is run, the result can be clipped to the Bay Area boundaries (which we do in the first method).</p>
</div>
<div class="section" id="method-1-display">
<h3>Method 1 - Display<a class="headerlink" href="#method-1-display" title="Permalink to this headline">¶</a></h3>
<p>This method uses <code class="docutils literal notranslate"><span class="pre">geoplot</span></code>, a high-level plotting library for geospatial data that complements <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>. For more information on <code class="docutils literal notranslate"><span class="pre">geoplot</span></code>, check out the <a class="reference external" href="https://residentmario.github.io/geoplot/index.html">documentation</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set projection to WGS 84 and reproject data</span>
<span class="n">proj_wgs</span> <span class="o">=</span> <span class="mi">4326</span>
<span class="n">counties_wgs</span> <span class="o">=</span> <span class="n">counties</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj_wgs</span><span class="p">)</span>
<span class="n">wells_wgs</span> <span class="o">=</span> <span class="n">wells</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj_wgs</span><span class="p">)</span>

<span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot data</span>
<span class="n">counties_wgs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">wells_wgs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gplt</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">wells_wgs</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;RdPu&quot;</span><span class="p">,</span> <span class="n">shade</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="n">counties_wgs</span><span class="p">,</span> <span class="n">thresh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - Kernel Density Estimation for Wells&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="method-2-display-and-export-with-scipy">
<h3>Method 2 - Display and export with <code class="docutils literal notranslate"><span class="pre">scipy</span></code><a class="headerlink" href="#method-2-display-and-export-with-scipy" title="Permalink to this headline">¶</a></h3>
<p>This method uses <code class="docutils literal notranslate"><span class="pre">scipy</span></code> to visualize and export the KDE result. The <code class="docutils literal notranslate"><span class="pre">scipy</span></code> package uses a Gaussian kernel for KDE.</p>
<p>For further reading, check out the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.gaussian_kde.html"><code class="docutils literal notranslate"><span class="pre">scipy</span></code> documentation</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Code adapted from https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.gaussian_kde.html</span>

<span class="c1"># Get X and Y coordinates of well points</span>
<span class="n">x_sp</span> <span class="o">=</span> <span class="n">wells</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
<span class="n">y_sp</span> <span class="o">=</span> <span class="n">wells</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>

<span class="c1"># Get minimum and maximum coordinate values of well points</span>
<span class="n">min_x_sp</span> <span class="o">=</span> <span class="n">x_sp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">max_x_sp</span> <span class="o">=</span> <span class="n">x_sp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">min_y_sp</span> <span class="o">=</span> <span class="n">y_sp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">max_y_sp</span> <span class="o">=</span> <span class="n">y_sp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="c1"># Create a 100 by 100 cell mesh grid</span>
<span class="c1"># Horizontal and vertical cell count should be the same</span>
<span class="n">XX_sp</span><span class="p">,</span> <span class="n">YY_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">min_x_sp</span><span class="p">:</span><span class="n">max_x_sp</span><span class="p">:</span><span class="mi">100</span><span class="n">j</span><span class="p">,</span> <span class="n">min_y_sp</span><span class="p">:</span><span class="n">max_y_sp</span><span class="p">:</span><span class="mi">100</span><span class="n">j</span><span class="p">]</span>

<span class="c1"># Create 2-D array of the coordinates (paired) of each cell in the mesh grid</span>
<span class="n">positions_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">XX_sp</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">YY_sp</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>

<span class="c1"># Create 2-D array of the coordinate values of the well points</span>
<span class="n">values_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x_sp</span><span class="p">,</span> <span class="n">y_sp</span><span class="p">])</span>

<span class="c1"># Create kernel density estimator using the values</span>
<span class="n">kde_sp</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">values_sp</span><span class="p">)</span>

<span class="c1"># Set kernel bandwidth (optional)</span>
<span class="n">kde_sp</span><span class="o">.</span><span class="n">set_bandwidth</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Evaluate the estimator and reshape the data to fit mesh grid</span>
<span class="n">Z_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">kde_sp</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">positions_sp</span><span class="p">),</span> <span class="n">XX_sp</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Plot data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">Z_sp</span><span class="p">),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;RdPu&quot;</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">min_x_sp</span><span class="p">,</span> <span class="n">max_x_sp</span><span class="p">,</span> <span class="n">min_y_sp</span><span class="p">,</span> <span class="n">max_y_sp</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_sp</span><span class="p">,</span> <span class="n">y_sp</span><span class="p">,</span> <span class="s1">&#39;k.&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - SciPy Kernel Density Estimation for Wells&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We can export the raster if necessary.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">export_kde_raster</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Export and save a kernel density raster.&#39;&#39;&#39;</span>

    <span class="c1"># Flip array vertically and rotate 270 degrees</span>
    <span class="n">Z_export</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Get resolution</span>
    <span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">XX</span><span class="p">)</span>
    <span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">YY</span><span class="p">)</span>

    <span class="c1"># Set transform</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="n">min_x</span> <span class="o">-</span> <span class="n">xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">-</span> <span class="n">yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Affine</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">)</span>

    <span class="c1"># Export array as raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span>
            <span class="n">driver</span> <span class="o">=</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">Z_export</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">Z_export</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">Z_export</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">,</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">new_dataset</span><span class="p">:</span>
            <span class="n">new_dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Z_export</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Export raster</span>
<span class="n">export_kde_raster</span><span class="p">(</span><span class="n">Z</span> <span class="o">=</span> <span class="n">Z_sp</span><span class="p">,</span> <span class="n">XX</span> <span class="o">=</span> <span class="n">XX_sp</span><span class="p">,</span> <span class="n">YY</span> <span class="o">=</span> <span class="n">YY_sp</span><span class="p">,</span>
                  <span class="n">min_x</span> <span class="o">=</span> <span class="n">min_x_sp</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">max_x_sp</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">=</span> <span class="n">min_y_sp</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">max_y_sp</span><span class="p">,</span>
                  <span class="n">proj</span> <span class="o">=</span> <span class="n">proj</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;bay-area-wells_kde_scipy.tif&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="method-3-display-and-export-with-scikit-learn">
<h3>Method 3 - Display and export with <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code><a class="headerlink" href="#method-3-display-and-export-with-scikit-learn" title="Permalink to this headline">¶</a></h3>
<p>This method uses <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> to visualize and export the KDE result. Unlike the <code class="docutils literal notranslate"><span class="pre">scipy</span></code> method, we are able to specify and change various estimator parameters, including the kernel type.</p>
<p>For further reading, check out the <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.KernelDensity.html#sklearn.neighbors.KernelDensity"><code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> documentation</a> and the <a class="reference external" href="https://scikit-learn.org/stable/auto_examples/neighbors/plot_species_kde.html#sphx-glr-auto-examples-neighbors-plot-species-kde-py">associated example</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get X and Y coordinates of well points</span>
<span class="n">x_sk</span> <span class="o">=</span> <span class="n">wells_wgs</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
<span class="n">y_sk</span> <span class="o">=</span> <span class="n">wells_wgs</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>

<span class="c1"># Get minimum and maximum coordinate values of well points</span>
<span class="n">min_x_sk</span> <span class="o">=</span> <span class="n">x_sk</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">max_x_sk</span> <span class="o">=</span> <span class="n">x_sk</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">min_y_sk</span> <span class="o">=</span> <span class="n">y_sk</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">max_y_sk</span> <span class="o">=</span> <span class="n">y_sk</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="c1"># Create a 100 by 100 cell mesh grid</span>
<span class="c1"># Horizontal and vertical cell count should be the same</span>
<span class="n">XX_sk</span><span class="p">,</span> <span class="n">YY_sk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">min_x_sk</span><span class="p">:</span><span class="n">max_x_sk</span><span class="p">:</span><span class="mi">100</span><span class="n">j</span><span class="p">,</span> <span class="n">min_y_sk</span><span class="p">:</span><span class="n">max_y_sk</span><span class="p">:</span><span class="mi">100</span><span class="n">j</span><span class="p">]</span>

<span class="c1"># Create 2-D array of the coordinates (paired) of each cell in the mesh grid</span>
<span class="n">positions_sk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">XX_sk</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">YY_sk</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># Create 2-D array of the coordinate values of the well points</span>
<span class="n">Xtrain_sk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x_sk</span><span class="p">,</span> <span class="n">y_sk</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># Get kernel density estimator (can change parameters as desired)</span>
<span class="n">kde_sk</span> <span class="o">=</span> <span class="n">KernelDensity</span><span class="p">(</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="mf">0.04</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">kernel</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">algorithm</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span>

<span class="c1"># Fit kernel density estimator to wells coordinates</span>
<span class="n">kde_sk</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">Xtrain_sk</span><span class="p">)</span>

<span class="c1"># Evaluate the estimator on coordinate pairs</span>
<span class="n">Z_sk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">kde_sk</span><span class="o">.</span><span class="n">score_samples</span><span class="p">(</span><span class="n">positions_sk</span><span class="p">))</span>

<span class="c1"># Reshape the data to fit mesh grid</span>
<span class="n">Z_sk</span> <span class="o">=</span> <span class="n">Z_sk</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">XX_sk</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="c1"># Plot data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">Z_sk</span><span class="p">),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;RdPu&quot;</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">min_x_sk</span><span class="p">,</span> <span class="n">max_x_sk</span><span class="p">,</span> <span class="n">min_y_sk</span><span class="p">,</span> <span class="n">max_y_sk</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_sk</span><span class="p">,</span> <span class="n">y_sk</span><span class="p">,</span> <span class="s1">&#39;k.&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">counties_wgs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - SciKit-Learn Kernel Density Estimation for Wells&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Export raster</span>
<span class="n">export_kde_raster</span><span class="p">(</span><span class="n">Z</span> <span class="o">=</span> <span class="n">Z_sk</span><span class="p">,</span> <span class="n">XX</span> <span class="o">=</span> <span class="n">XX_sk</span><span class="p">,</span> <span class="n">YY</span> <span class="o">=</span> <span class="n">YY_sk</span><span class="p">,</span>
                  <span class="n">min_x</span> <span class="o">=</span> <span class="n">min_x_sk</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">max_x_sk</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">=</span> <span class="n">min_y_sk</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">max_y_sk</span><span class="p">,</span>
                  <span class="n">proj</span> <span class="o">=</span> <span class="n">proj_wgs</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;bay-area-wells_kde_sklearn.tif&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>There are a few other ways to compute KDE in Python. This <a class="reference external" href="https://jakevdp.github.io/blog/2013/12/01/kernel-density-estimation/">article</a> reviews and compares all these implementations.</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="e_extraction.html" title="previous page">Extraction</a>
    <a class='right-next' id="next-link" href="e_vector_merge_dissolve.html" title="next page">Merge Data &amp; Dissolve Polygons</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Michael Mann, Steven Chao, Jordan Graesser, Nina Feldman<br/>
        
          <div class="extra_footer">
            <div>
    <b>Supported by:</b>  <br>
    <a href="https://geography.columbian.gwu.edu/">
 <img alt="GW Geography" src="../_static/global/GWBlue.png"
  width="300" align="left">
</div>
<div>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" ><img align="right" alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a> 
</div>

          </div>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-192844775-1', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </body>
</html>

<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content="Learn how to interpolate spatial data using python. Interpolation is the process of using locations with known, sampled values (of a phenomenon) to estimate the values at unknown, unsampled areas." lang="en" name="description" xml:lang="en" />
<meta content="python, spatial, interpolation, vector, shapefile" name="keywords" />
<meta content="en_US" property="og:locale" />

    <title>Spatial Interpolation &#8212; Python Open Source Spatial Programming &amp; Remote Sensing</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="../_static/tabs.js?v=3ee01567"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-MQPNBR6XWJ"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-MQPNBR6XWJ');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-MQPNBR6XWJ');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'docs/e_interpolation';</script>
    <link rel="canonical" href="https://pygis.io/docs/e_interpolation.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Reading &amp; Writing Rasters with Rasterio" href="e_new_rasters.html" />
    <link rel="prev" title="Point Density Measures - Counts &amp; Kernel Density" href="e_summarize_vector.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="a_intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/pygis.png" class="logo__image only-light" alt="Python Open Source Spatial Programming & Remote Sensing - Home"/>
    <img src="../_static/pygis.png" class="logo__image only-dark pst-js-only" alt="Python Open Source Spatial Programming & Remote Sensing - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="a_intro.html">
                    PyGIS - Open Source Spatial Programming & Remote Sensing
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">0 - Get Started in Spatial Python</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="b_intro_py.html">Welcome - Let’s get started</a></li>
<li class="toctree-l1"><a class="reference internal" href="b_about_py.html">Getting Started in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="b_getting_started.html">Setting up a Normal Python Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="b_conda_started2.html">Geospatial Environment Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="b_python_by_example.html">An Introductory Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="b_learn_more.html">Learn More</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">1 - Spatial Data Types in Python</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="c_features.html">Spatial Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="c_store_features.html">Data Storage Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="c_vectors.html">Working with Spatial Vector Data using GeoPandas</a></li>
<li class="toctree-l1"><a class="reference internal" href="c_new_vectors.html">Manipulating Spatial Objects: Points, Lines, Polygons in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="c_rasters.html">Spatial Raster Data in Python</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">2 - Nature of Coordinate Systems in Python</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="d_crs_what_is_it.html">What is a CRS?</a></li>
<li class="toctree-l1"><a class="reference internal" href="d_understand_crs_codes.html">Understanding a CRS: Proj4 and CRS codes</a></li>
<li class="toctree-l1"><a class="reference internal" href="d_affine.html">Affine Transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="d_vector_crs_intro.html">Vector Coordinate Reference Systems (CRS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="d_raster_crs_intro.html">Raster Coordinate Reference Systems (CRS)</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">3 - Vector Operations in Python</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="e_attributes.html">Attributes &amp; Indexing for Vector Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_buffer_neighbors.html">Proximity Analysis - Buffers, Nearest Neighbor</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_vector_merge_dissolve.html">Merge Data &amp; Dissolve Polygons</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_extraction.html">Extracting Spatial Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_vector_overlay.html">Spatial Overlays and Joins</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_spatial_joins.html">Spatial Joins</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_summarize_vector.html">Point Density Measures - Counts &amp; Kernel Density</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Spatial Interpolation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">4 - Raster Operations in Python</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="e_new_rasters.html">Reading &amp; Writing Rasters with Rasterio</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_raster_reproject.html">Reproject Rasters w. Rasterio and Geowombat</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_raster_resample.html">Resampling &amp; Registering Rasters w. Rasterio and Geowombat</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_raster_math.html">Band Math w. Rasterio</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_raster_replace_values.html">Replacing Values w. Rasterio</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_raster_rasterize.html">Rasterize Vectors w. Rasterio</a></li>
<li class="toctree-l1"><a class="reference internal" href="e_raster_window_operations.html">Window Operations with Rasterio and GeoWombat</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">5 - Accessing OSM &amp; Census Data in Python</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="d_access_osm.html">Accessing OSM Data in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="d_access_census.html">Accessing Census and ACS Data in Python</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">6 - Remote Sensing in Python</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="f_rs_io.html">Reading/Writing Remote Sensed Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_rs_config.html">Configuration manager</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_rs_edit.html">Editing Rasters and Remotely Sensed Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_rs_plot.html">Plot Remote Sensed Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_rs_crs.html">Remote Sensing Coordinate Reference Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_rs_mosaic.html">Handle Multiple Remotely Sensed Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_rs_band_math.html">Band Math &amp; Vegetation Indices</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_rs_extraction.html">Raster Data Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="f_rs_ml_predict.html">Spatial Prediction using ML in Python</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Hire pygis.io</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="g_hire.html">Pygis.io Consultancy</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/mmann1123/pyGIS" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/mmann1123/pyGIS/edit/main/./pygis/docs/e_interpolation.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/mmann1123/pyGIS/issues/new?title=Issue%20on%20page%20%2Fdocs/e_interpolation.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/docs/e_interpolation.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Spatial Interpolation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#thiessen-polygons-voronoi-diagrams">Thiessen Polygons (Voronoi Diagrams)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#k-nearest-neighbors">K-Nearest Neighbors</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kriging">Kriging</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#method-1-using-pykrige">Method 1 - Using <code class="docutils literal notranslate"><span class="pre">PyKrige</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#method-2-using-scikit-learn">Method 2- Using <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Method 2- Using <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code></a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="spatial-interpolation">
<h1>Spatial Interpolation<a class="headerlink" href="#spatial-interpolation" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<div class="admonition-learning-objectives admonition">
<p class="admonition-title">Learning Objectives</p>
<ul class="simple">
<li><p>Conduct various types of interpolation on point dataset</p></li>
<li><p>Obtain interpolated values at specified unsampled locations</p></li>
</ul>
</div>
<div class="admonition-review admonition">
<p class="admonition-title">Review</p>
<ul class="simple">
<li><p><a class="reference internal" href="c_vectors.html"><span class="std std-doc">Spatial Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="e_attributes.html"><span class="std std-doc">Attributes &amp; Indexing for Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="c_new_vectors.html"><span class="std std-doc">Creating Spatial Vector Data</span></a></p></li>
<li><p><a class="reference internal" href="e_vector_merge_dissolve.html"><span class="std std-doc">Merge Data &amp; Dissolve Polygons</span></a></p></li>
</ul>
</div>
<hr class="docutils" />
<p>Interpolation is the process of using locations with known, sampled values (of a phenomenon) to estimate the values at unknown, unsampled areas <a class="footnote-reference brackets" href="#bolstad" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>. In this chapter, we will explore three interpolation methods: Thiessen polygons (Voronoi diagrams), k-nearest neighbors (KNN), and kriging.</p>
<p>We will first begin by importing modules (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import modules</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pykrige.ok</span> <span class="kn">import</span> <span class="n">OrdinaryKriging</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">rasterio.mask</span>
<span class="kn">from</span> <span class="nn">rasterio.plot</span> <span class="kn">import</span> <span class="n">show</span>
<span class="kn">from</span> <span class="nn">rasterio.transform</span> <span class="kn">import</span> <span class="n">Affine</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">Voronoi</span><span class="p">,</span> <span class="n">voronoi_plot_2d</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">box</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span><span class="p">,</span> <span class="n">Point</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process</span> <span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>We will utilize shapefiles of San Francisco Bay Area county boundaries and rainfall “values” that were “sampled” in the Bay Area. We will load in the data and reproject the data (click the + below to show code cell).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is critical to use a ‘projected’ coordinate system when doing interpolation. If you keep your data in geographic lat lon distances will vary significantly as you move up and down in latitude… since interpolation depends on distance as a way of establishing relationships this would be a problem… a big one.</p>
</div>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load data</span>

<span class="c1"># County boundaries</span>
<span class="c1"># Source: https://opendata.mtc.ca.gov/datasets/san-francisco-bay-region-counties-clipped?geometry=-125.590%2C37.123%2C-119.152%2C38.640</span>
<span class="n">counties</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../_static/e_vector_shapefiles/sf_bay_counties/sf_bay_counties.shp&quot;</span><span class="p">)</span>

<span class="c1"># Rainfall measurement &quot;locations&quot;</span>
<span class="c1"># Source: https://earthworks.stanford.edu/catalog/stanford-td754wr4701</span>
<span class="c1"># Modified by author by clipping raster to San Francisco Bay Area, generating random points, and extracting raster values (0-255) to the points</span>
<span class="n">rainfall</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../_static/e_vector_shapefiles/sf_bay_rainfall/sf_bay_rainfall.shp&quot;</span><span class="p">)</span>

<span class="c1"># Reproject data to CA Teale Albert</span>
<span class="c1"># https://nrm.dfg.ca.gov/FileHandler.ashx?DocumentID=109326&amp;inline</span>
<span class="n">proj</span> <span class="o">=</span> <span class="s2">&quot;+proj=aea +lat_1=34 +lat_2=40.5 +lat_0=0 +lon_0=-120 +x_0=0 +y_0=-4000000 +ellps=GRS80 +datum=NAD83 +units=m +no_defs &quot;</span>
<span class="n">counties</span> <span class="o">=</span> <span class="n">counties</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
<span class="n">rainfall</span> <span class="o">=</span> <span class="n">rainfall</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>Next, we’ll prepare the data for geoprocessing (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get X and Y coordinates of rainfall points</span>
<span class="n">x_rain</span> <span class="o">=</span> <span class="n">rainfall</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span>
<span class="n">y_rain</span> <span class="o">=</span> <span class="n">rainfall</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span>

<span class="c1"># Create list of XY coordinate pairs</span>
<span class="n">coords_rain</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span> <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x_rain</span><span class="p">,</span> <span class="n">y_rain</span><span class="p">)]</span>

<span class="c1"># Get extent of counties feature</span>
<span class="n">min_x_counties</span><span class="p">,</span> <span class="n">min_y_counties</span><span class="p">,</span> <span class="n">max_x_counties</span><span class="p">,</span> <span class="n">max_y_counties</span> <span class="o">=</span> <span class="n">counties</span><span class="o">.</span><span class="n">total_bounds</span>

<span class="c1"># Get list of rainfall &quot;values&quot;</span>
<span class="n">value_rain</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rainfall</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">])</span>

<span class="c1"># Create a copy of counties dataset</span>
<span class="n">counties_dissolved</span> <span class="o">=</span> <span class="n">counties</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Add a field with constant value of 1</span>
<span class="n">counties_dissolved</span><span class="p">[</span><span class="s2">&quot;constant&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Dissolve all counties to create one polygon</span>
<span class="n">counties_dissolved</span> <span class="o">=</span> <span class="n">counties_dissolved</span><span class="o">.</span><span class="n">dissolve</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s2">&quot;constant&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>We will also define a function for exporting rasters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">export_kde_raster</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Export and save a kernel density raster.&#39;&#39;&#39;</span>

    <span class="c1"># Get resolution</span>
    <span class="n">xres</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">XX</span><span class="p">)</span>
    <span class="n">yres</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">YY</span><span class="p">)</span>

    <span class="c1"># Set transform</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">Affine</span><span class="o">.</span><span class="n">translation</span><span class="p">(</span><span class="n">min_x</span> <span class="o">-</span> <span class="n">xres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">-</span> <span class="n">yres</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">Affine</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">)</span>

    <span class="c1"># Export array as raster</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span>
            <span class="n">driver</span> <span class="o">=</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
            <span class="n">height</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">,</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">new_dataset</span><span class="p">:</span>
            <span class="n">new_dataset</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>With any model used for prediction, it is important to assess the model fit for unobserved locations (or the accuracy of the values predicted by the model in relation to their actual values). Thus, in order to assess the fit, we break our data into two portions, a “training” data set used to train the model, and a “testing” set that remains “unseen” by the model but can be used to assess model performance. Effectively, we can use this “unseen” testing subset to validate the model because we can compare their true values with the estimated value from the model prediction.</p>
<p>We will separate our rainfall dataset into two subsets: one for training and the other for testing. These subsets will be used in our KNN and kriging analyses.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Split data into testing and training sets</span>
<span class="n">coords_rain_train</span><span class="p">,</span> <span class="n">coords_rain_test</span><span class="p">,</span> <span class="n">value_rain_train</span><span class="p">,</span> <span class="n">value_rain_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">coords_rain</span><span class="p">,</span> <span class="n">value_rain</span><span class="p">,</span> <span class="n">test_size</span> <span class="o">=</span> <span class="mf">0.20</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>

<span class="c1"># Create separate GeoDataFrames for testing and training sets</span>
<span class="n">rain_train_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">coords_rain_train</span><span class="p">],</span> <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">)</span>
<span class="n">rain_train_gdf</span><span class="p">[</span><span class="s2">&quot;Actual_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_rain_train</span>
<span class="n">rain_test_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">coords_rain_test</span><span class="p">],</span> <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">)</span>
<span class="n">rain_test_gdf</span><span class="p">[</span><span class="s2">&quot;Actual_Value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value_rain_test</span>

<span class="c1"># Get minimum and maximum coordinate values of rainfall training points</span>
<span class="n">min_x_rain</span><span class="p">,</span> <span class="n">min_y_rain</span><span class="p">,</span> <span class="n">max_x_rain</span><span class="p">,</span> <span class="n">max_y_rain</span> <span class="o">=</span> <span class="n">rain_train_gdf</span><span class="o">.</span><span class="n">total_bounds</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s plot our data!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Stylize plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

<span class="c1"># Plot data</span>
<span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;bisque&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">rain_train_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;limegreen&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">rain_test_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;royalblue&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - Rainfall Measurement Locations&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;San Francisco Bay Area - Rainfall Measurement Locations&#39;)
</pre></div>
</div>
<img alt="../_images/ea97059f458a8d0bb8daf65041adf4b8b9ababe47dfcdf4cd6370fb0554569ca.png" src="../_images/ea97059f458a8d0bb8daf65041adf4b8b9ababe47dfcdf4cd6370fb0554569ca.png" />
</div>
</div>
<p>In the map above, the green and blue points are the rainfall points that we loaded separated into the training set and testing set, respectively.</p>
<section id="thiessen-polygons-voronoi-diagrams">
<h2>Thiessen Polygons (Voronoi Diagrams)<a class="headerlink" href="#thiessen-polygons-voronoi-diagrams" title="Link to this heading">#</a></h2>
<p>Thiessen polygons (also known as Voronoi diagrams) polygons allow us to perform nearest neighbor interpolation, which is perhaps the most basic type of interpolation. Thiessen polygons are be constructed around each sampled point so all the space within a specific polygon is closest in distance to that sampled point (as compared to other sampled points). Then, to perform nearest neighbor interpolation, all that space is assigned the value of that sampled point. <a class="footnote-reference brackets" href="#bolstad" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p>
<p>We can use the <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.spatial.Voronoi.html"><code class="docutils literal notranslate"><span class="pre">scipy</span></code> package</a> to create Thiessen polygons. After running the <code class="docutils literal notranslate"><span class="pre">Voronoi()</span></code> function, we can use the <code class="docutils literal notranslate"><span class="pre">vertices</span></code> attribute to get a list of vertices, which we can subsequently use to generate polygons.</p>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>When creating Thiessen polygons, the sample points toward the edges of the point shapefile’s extent will have infinite Voronoi regions, because not all sides of these edge points have adjacent sample points that would constrain the regions. Consequently, these infinite regions will not be exported. To mitigate this issue, we can create dummy points well beyond the extent of our datasets, which will create finite Voronoi regions for all of our actual sample points. Then, we can clip the regions to our extent shapefile (creating dummy points far away from our actual sample points will ensure the dummy points and their infinite Voronoi regions do not interfere with the sample points and their associated finite Voronoi regions after all regions are clipped).</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extend extent of counties feature by using buffer</span>
<span class="n">counties_buffer</span> <span class="o">=</span> <span class="n">counties</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>

<span class="c1"># Get extent of buffered input feature</span>
<span class="n">min_x_cty_tp</span><span class="p">,</span> <span class="n">min_y_cty_tp</span><span class="p">,</span> <span class="n">max_x_cty_tp</span><span class="p">,</span> <span class="n">max_y_cty_tp</span> <span class="o">=</span> <span class="n">counties_buffer</span><span class="o">.</span><span class="n">total_bounds</span>

<span class="c1"># Use extent to create dummy points and add them to list of coordinates</span>
<span class="n">coords_tp</span> <span class="o">=</span> <span class="n">coords_rain_train</span> <span class="o">+</span> <span class="p">[[</span><span class="n">min_x_cty_tp</span><span class="p">,</span> <span class="n">min_y_cty_tp</span><span class="p">],</span> <span class="p">[</span><span class="n">max_x_cty_tp</span><span class="p">,</span> <span class="n">min_y_cty_tp</span><span class="p">],</span>
                                 <span class="p">[</span><span class="n">max_x_cty_tp</span><span class="p">,</span> <span class="n">max_y_cty_tp</span><span class="p">],</span> <span class="p">[</span><span class="n">min_x_cty_tp</span><span class="p">,</span> <span class="n">max_y_cty_tp</span><span class="p">]]</span>

<span class="c1"># Compute Voronoi diagram</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">Voronoi</span><span class="p">(</span><span class="n">coords_tp</span><span class="p">)</span>

<span class="c1"># Create empty list of hold Voronoi polygons</span>
<span class="n">tp_poly_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Create a polygon for each region</span>
<span class="c1"># &#39;regions&#39; attribute provides a list of indices of the vertices (in the &#39;vertices&#39; attribute) that make up the region</span>
<span class="c1"># Source: https://docs.scipy.org/doc/scipy/reference/generated/scipy.spatial.Voronoi.html</span>
<span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">tp</span><span class="o">.</span><span class="n">regions</span><span class="p">:</span>

    <span class="c1"># Ignore region if -1 is in the list (based on documentation)</span>
    <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">region</span><span class="p">:</span>

        <span class="c1"># Return to top of loop</span>
        <span class="k">continue</span>

    <span class="c1"># Otherwise, pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Check that region list has values in it</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">region</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

        <span class="c1"># Create a polygon by using the region list to call the correct elements in the &#39;vertices&#39; attribute</span>
        <span class="n">tp_poly_region</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tp</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">region</span><span class="p">]))</span>

        <span class="c1"># Append polygon to list</span>
        <span class="n">tp_poly_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tp_poly_region</span><span class="p">)</span>

    <span class="c1"># If no values, return to top of loop</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">continue</span>

<span class="c1"># Create GeoDataFrame from list of polygon regions</span>
<span class="n">tp_polys</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">tp_poly_list</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">)</span>

<span class="c1"># Clip polygon regions to the counties boundary</span>
<span class="n">tp_polys_clipped</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">tp_polys</span><span class="p">,</span> <span class="n">counties_dissolved</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>A spatial join can be conducted to assign the rainfall training “values” to its associated Thiessen polygon.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># If rainfall point within the polygon, assign that rainfall value to the polygon</span>
<span class="n">tp_polys_clipped_values</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">rain_train_gdf</span><span class="p">,</span> <span class="n">tp_polys_clipped</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;within&#39;</span><span class="p">)</span>

<span class="c1"># Drop un-needed column</span>
<span class="n">tp_polys_clipped_values</span> <span class="o">=</span> <span class="n">tp_polys_clipped_values</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;index_left&quot;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Rename column</span>
<span class="n">tp_polys_clipped_values</span> <span class="o">=</span> <span class="n">tp_polys_clipped_values</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Actual_Value&quot;</span><span class="p">:</span> <span class="s2">&quot;VALUE_Thiessen&quot;</span><span class="p">})</span>

<span class="c1"># Display head of attribute table</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attribute Table: Thiessen Polygon Interpolated Values&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">tp_polys_clipped_values</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># If rainfall point within the polygon, assign that rainfall value to the polygon</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">tp_polys_clipped_values</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">rain_train_gdf</span><span class="p">,</span> <span class="n">tp_polys_clipped</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;within&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="c1"># Drop un-needed column</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">tp_polys_clipped_values</span> <span class="o">=</span> <span class="n">tp_polys_clipped_values</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;index_left&quot;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="nn">File ~/miniconda3/envs/pygis/lib/python3.11/site-packages/geopandas/tools/sjoin.py:110,</span> in <span class="ni">sjoin</span><span class="nt">(left_df, right_df, how, predicate, lsuffix, rsuffix, distance, on_attribute, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span> <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span>     <span class="n">first</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="ne">--&gt; </span><span class="mi">110</span>     <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sjoin() got an unexpected keyword argument &#39;</span><span class="si">{</span><span class="n">first</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">112</span> <span class="n">on_attribute</span> <span class="o">=</span> <span class="n">_maybe_make_list</span><span class="p">(</span><span class="n">on_attribute</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">114</span> <span class="n">_basic_checks</span><span class="p">(</span><span class="n">left_df</span><span class="p">,</span> <span class="n">right_df</span><span class="p">,</span> <span class="n">how</span><span class="p">,</span> <span class="n">lsuffix</span><span class="p">,</span> <span class="n">rsuffix</span><span class="p">,</span> <span class="n">on_attribute</span><span class="o">=</span><span class="n">on_attribute</span><span class="p">),</span>

<span class="ne">TypeError</span>: sjoin() got an unexpected keyword argument &#39;op&#39;
</pre></div>
</div>
</div>
</div>
<p>A second spatial join can be conducted to assign those values from the Thiessen polygons to the points from the testing dataset (only if a test point falls within a polygon). We can subsequently get the out-of-sample r-squared value, which is calculated by using the data points that the model did not use (the testing dataset) and comparing the testing dataset’s actual values to the values as predicted by the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># If test point is within a polygon, assign that polygon&#39;s value to the test point</span>
<span class="n">rain_test_pred_tp</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">rain_test_gdf</span><span class="p">,</span> <span class="n">tp_polys_clipped_values</span><span class="p">,</span> <span class="n">how</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="s1">&#39;within&#39;</span><span class="p">)</span>

<span class="c1"># Drop un-needed column</span>
<span class="n">rain_test_pred_tp</span> <span class="o">=</span> <span class="n">rain_test_pred_tp</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;index_right&quot;</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Rename column</span>
<span class="n">rain_test_pred_tp</span> <span class="o">=</span> <span class="n">rain_test_pred_tp</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Actual_Value&quot;</span><span class="p">:</span> <span class="s2">&quot;VALUE_Actual&quot;</span><span class="p">,</span> <span class="s2">&quot;VALUE_Thiessen&quot;</span><span class="p">:</span> <span class="s2">&quot;VALUE_Predict&quot;</span><span class="p">})</span>

<span class="c1"># Generate out-of-sample R^2</span>
<span class="n">out_r_squared_tp</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">rain_test_pred_tp</span><span class="o">.</span><span class="n">VALUE_Actual</span><span class="p">,</span> <span class="n">rain_test_pred_tp</span><span class="o">.</span><span class="n">VALUE_Predict</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Thiessen polygon out-of-sample r-squared: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">out_r_squared_tp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

<span class="c1"># Display attribute table</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Attribute Table: Testing Dataset Interpolated Values - Thiessen Polygon Method&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">rain_test_pred_tp</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Plotting the data, we see that each polygon has one green training point (and vice-versa). All space within one polygon is closest to the known training point (green dot) within the polygon. The testing points (blue dots) are assigned the value of the Thiessen polygon in which it falls.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

<span class="c1"># Stylize plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

<span class="c1"># Plot data</span>
<span class="n">counties_dissolved</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">tp_polys_clipped</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;Set3&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">rain_train_gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;limegreen&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">rain_test_pred_tp</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;royalblue&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>

<span class="c1"># Iterate through each rainfall train point to add a label with its value to the plot</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rain_train_gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">Actual_Value</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>

<span class="c1"># Iterate through each rainfall test point to add a label with its value to the plot</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rain_test_pred_tp</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">VALUE_Predict</span><span class="p">,</span> <span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - Rainfall Measurement Locations &amp; Thiessen Polygons&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<p>In addition to <code class="docutils literal notranslate"><span class="pre">vertices</span></code>, there are a few other attributes we can call if we want to further explore the polygons. These attributes will provide actual values (e.g., vertices) or provide the indices for querying other attributes. <a class="footnote-reference brackets" href="#scipy-voronoi" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a></p>
<p>In the example below, we demonstrate how to extract the value of one of the Thiessen polygons at a new location for which we want a predicted value. We use the <code class="docutils literal notranslate"><span class="pre">point_region</span></code> attribute to provide the index of a point’s Voronoi region, and we use that index to get the region in <code class="docutils literal notranslate"><span class="pre">regions</span></code>. That provides indices of the vertices that make up the polygon, which we use to get the appropriate values in <code class="docutils literal notranslate"><span class="pre">vertices</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set index for feature of interest</span>
<span class="n">feature_index_one</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># Get a Voronoi polygon for one feature</span>
<span class="c1"># &#39;point_region&#39; attribute provides the index of the Voronoi region belonging to a specified point</span>
<span class="c1"># Can use the index to call the appropriate element in the &#39;regions&#39; attribute</span>
<span class="n">tp_poly_region_one</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">tp</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">tp</span><span class="o">.</span><span class="n">point_region</span><span class="p">[</span><span class="n">feature_index_one</span><span class="p">]]])</span>

<span class="c1"># Create GeoDataFrame for polygon</span>
<span class="n">tp_poly_region_one</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">([</span><span class="n">tp_poly_region_one</span><span class="p">],</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">],</span> <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">)</span>

<span class="c1"># Clip polygon to county boundary</span>
<span class="n">tp_poly_region_one</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">tp_poly_region_one</span><span class="p">,</span> <span class="n">counties_dissolved</span><span class="p">)</span>

<span class="c1"># Get the equivalent feature from the rainfall dataset</span>
<span class="n">rain_one</span> <span class="o">=</span> <span class="n">rain_train_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">feature_index_one</span><span class="p">]]</span>

<span class="c1"># Add the rainfall value to the polygon attribute table</span>
<span class="n">tp_poly_region_one</span><span class="p">[</span><span class="s2">&quot;VALUE_Predict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rain_one</span><span class="p">[</span><span class="s2">&quot;Actual_Value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Display attribute table</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attribute Table: Thiessen Polygon Interpolated Value&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">tp_poly_region_one</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s how that one Thiessen polygon looks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subplots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># Stylize plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

<span class="c1"># Plot data</span>
<span class="n">tp_poly_region_one</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;lightseagreen&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">rain_one</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - One Point and Thiessen Polygon&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="k-nearest-neighbors">
<h2>K-Nearest Neighbors<a class="headerlink" href="#k-nearest-neighbors" title="Link to this heading">#</a></h2>
<p>KNN (also stylized as kNN) is a neighbor-based learning method that can be used for interpolation. Unlike the Thiessen polygons method, KNN looks for a specified number <code class="docutils literal notranslate"><span class="pre">K</span></code> of sampled points closest to an unknown point. The <code class="docutils literal notranslate"><span class="pre">K</span></code> known points can be used to predict the value (discrete or continuous) of the unknown point. <a class="footnote-reference brackets" href="#sk-nn" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a></p>
<p>We can use the <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.KNeighborsRegressor.html"><code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> module</a> to perform KNN analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set number of neighbors to look for</span>
<span class="n">neighbors</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># Initialize KNN regressor</span>
<span class="n">knn_regressor</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span> <span class="o">=</span> <span class="n">neighbors</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="s2">&quot;distance&quot;</span><span class="p">)</span>

<span class="c1"># Fit regressor to data</span>
<span class="n">knn_regressor</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">coords_rain_train</span><span class="p">,</span> <span class="n">value_rain_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have created the KNN model, we can get the in-sample r-squared value. An in-sample statistic, as suggested by its name, is calculated by using the data that were used to build the model (the “training” dataset).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate in-sample R^2</span>
<span class="n">in_r_squared_knn</span> <span class="o">=</span> <span class="n">knn_regressor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">coords_rain_train</span><span class="p">,</span> <span class="n">value_rain_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;KNN in-sample r-squared: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">in_r_squared_knn</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Here, the in-sample r-squared value is 100% because KNN is a “exact interpolator.” For exact interpolators, estimated values for known points are exactly equal to actual values. Other methods like Kriging, shown below, are inexact interpolators. For inexact interpolators, estimated values for known points are not exactly equal to actual values. Here’s a <a class="reference external" href="https://www.onestopgis.com/GIS-Theory-and-Techniques/Spatial-Interpolation/Elements-of-Spatial-Interpolation/posts/Types-of-Spatial-Interpolation/Image-shows-Exact-interpolation-and-Inexact-interpolation.png?__cf_chl_jschl_tk__=231d8a46e00aa6fe5352048bff01af55174b6c40-1625260397-0-ARqVOIsPHXJ9wPUqWrXKldltKnf_3GrT_RVaKb7djF6cUYCwnIzVeYww8nW4e_3GiIiCNZ15eVXmksePbUz-sKbuHtD2UsSh9OWZ4w2Y2dS_zCeIMCVRUIrYCjZEEcH722m7Y2vCDGAaA6gh1RObvtBx_3Se3gCdldO6c65zunRmX4vE0jLONpdckY6MEo4YPiyZr_11QAdPLYBWwgtl3wC2XhM5mhsmVYmInXWYTiyr35sXWVn86DedDNC2rKMnvrQGo8BuBgjskX6uf_Y3tWWpYCpyghV9s0zpygqgTQYG8rNaKJyFFQdoX--tMMEYY2AwzAI2BNmAxlGlxM07tBndOjZFgphEsU9nbFhOAB-Wji4u0wwD_N97FBKdFwsNl8bGbPSpLoiIMZ94GVZqETiD29W_lFPsiunLAt3EU2Ra-pf2QC1lCaUUhUt2aCIgHH6SnzTAm-JictSfAD4cnYolpP7D27Cj_UOGLSfo2sk4KcOH9JAG3ZGF1UCkX2fBUTivVWmuYPL4l1xaGS7e0BgKuiz_TdAbeMNkyi2TtWgMzT2sZEqf5QXZzvSwbsOVf5Z8ph6imf4gaHYhhYU87yKTDkK8PnYkbuyS3zeDWnM7hTj-Gn-LtNSYpiTjA68NZA">visual of inexact versus exact interpolators</a>.</p>
<p>Similarily, we can also get the out-of-sample r-squared value and compare the test dataset’s actual values to the values as predicted by the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate out-of-sample R^2</span>
<span class="n">out_r_squared_knn</span> <span class="o">=</span> <span class="n">knn_regressor</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">coords_rain_test</span><span class="p">,</span> <span class="n">value_rain_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;KNN out-of-sample r-squared: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">out_r_squared_knn</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

<span class="c1"># Predict values for testing dataset</span>
<span class="n">coords_rain_test_predict_knn</span> <span class="o">=</span> <span class="n">knn_regressor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">coords_rain_test</span><span class="p">)</span>

<span class="c1"># Create dictionary holding the actual and predicted values</span>
<span class="n">predict_dict_knn</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Coordinate_Pair&quot;</span><span class="p">:</span> <span class="n">coords_rain_test</span><span class="p">,</span> <span class="s2">&quot;VALUE_Actual&quot;</span><span class="p">:</span> <span class="n">value_rain_test</span><span class="p">,</span> <span class="s2">&quot;VALUE_Predict&quot;</span><span class="p">:</span> <span class="n">coords_rain_test_predict_knn</span><span class="p">}</span>

<span class="c1"># Create dataframe from dictionary</span>
<span class="n">predict_df_knn</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">predict_dict_knn</span><span class="p">)</span>

<span class="c1"># Display attribute table</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Attribute Table: Testing Set Interpolated Values - KNN Method&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">predict_df_knn</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Out-of-sample r-squared looks pretty strong!</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you are just interested in identifying the <code class="docutils literal notranslate"><span class="pre">k</span></code> nearest neighbors (no interpolation), use the <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.NearestNeighbors.html#sklearn.neighbors.NearestNeighbors"><code class="docutils literal notranslate"><span class="pre">NearestNeighbors()</span></code> function</a>.</p>
</div>
</section>
<section id="kriging">
<h2>Kriging<a class="headerlink" href="#kriging" title="Link to this heading">#</a></h2>
<p>Kriging is a type of interpolation that uses a semivariogram, which measures spatial autocorrelation (how similar close points are in value and how this similarity changes as distance between points increases). Thus, the semivariogram determines how much influence a known point has on an unknown point as the distance between the known point and the unknown point increases. In other words, the weight of a known point on an unknown point decreases with increasing distance, and the semivariogram determines how quickly that weight tapers with increasing distance. <a class="footnote-reference brackets" href="#bolstad" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>, <a class="footnote-reference brackets" href="#esri-kriging" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a></p>
<p>For more information, see this <a class="reference external" href="https://pro.arcgis.com/en/pro-app/latest/tool-reference/3d-analyst/how-kriging-works.htm">ArcGIS help guide on kriging</a>.</p>
<p>Two Python packages that can be used for kriging include <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> and <code class="docutils literal notranslate"><span class="pre">pykrige</span></code>. The former package works best when the input data has a WGS 84 projection, so we will begin by reprojecting all of our data to that coordinate system (click the + below to show code cell).</p>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Set projection to WGS 84 and reproject data</span>
<span class="sd">proj_wgs = 4326</span>
<span class="sd">counties_wgs = counties.to_crs(proj_wgs)</span>
<span class="sd">rainfall_wgs = rainfall.to_crs(proj_wgs)</span>
<span class="sd">rain_train_gdf_wgs = rain_train_gdf.to_crs(proj_wgs)</span>
<span class="sd">rain_test_gdf_wgs = rain_test_gdf.to_crs(proj_wgs)</span>

<span class="sd"># Get X and Y coordinates of rainfall points</span>
<span class="sd">x_rain_wgs = rainfall_wgs[&quot;geometry&quot;].x</span>
<span class="sd">y_rain_wgs = rainfall_wgs[&quot;geometry&quot;].y</span>

<span class="sd"># Create list of XY coordinate pairs</span>
<span class="sd">coords_rain_train_wgs = [list(xy) for xy in zip(rain_train_gdf_wgs[&quot;geometry&quot;].x, rain_train_gdf_wgs[&quot;geometry&quot;].y)]</span>
<span class="sd">coords_rain_test_wgs = [list(xy) for xy in zip(rain_test_gdf_wgs[&quot;geometry&quot;].x, rain_test_gdf_wgs[&quot;geometry&quot;].y)]</span>

<span class="sd"># Get minimum and maximum coordinate values of rainfall points</span>
<span class="sd">min_x_rain_wgs, min_y_rain_wgs, max_x_rain_wgs, max_y_rain_wgs = rain_train_gdf_wgs.total_bounds</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="method-1-using-pykrige">
<h3>Method 1 - Using <code class="docutils literal notranslate"><span class="pre">PyKrige</span></code><a class="headerlink" href="#method-1-using-pykrige" title="Link to this heading">#</a></h3>
<p>The <a class="reference external" href="https://geostat-framework.readthedocs.io/projects/pykrige/en/stable/index.html"><code class="docutils literal notranslate"><span class="pre">pykrige</span></code> module</a> offers ordinary and universal kriging. It also supports various variogram models in addition to Gaussian.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Adapted from: https://geostat-framework.readthedocs.io/projects/pykrige/en/latest/examples/04_krige_geometric.html</span>

<span class="c1"># Create a 100 by 100 grid</span>
<span class="c1"># Horizontal and vertical cell counts should be the same</span>
<span class="n">XX_pk_krig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_x_rain</span><span class="p">,</span> <span class="n">max_x_rain</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">YY_pk_krig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_y_rain</span><span class="p">,</span> <span class="n">max_y_rain</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># Generate ordinary kriging object</span>
<span class="n">OK</span> <span class="o">=</span> <span class="n">OrdinaryKriging</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_rain</span><span class="p">),</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_rain</span><span class="p">),</span>
    <span class="n">value_rain</span><span class="p">,</span>
    <span class="n">variogram_model</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">enable_plotting</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">coordinates_type</span> <span class="o">=</span> <span class="s2">&quot;euclidean&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Evaluate the method on grid</span>
<span class="n">Z_pk_krig</span><span class="p">,</span> <span class="n">sigma_squared_p_krig</span> <span class="o">=</span> <span class="n">OK</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;grid&quot;</span><span class="p">,</span> <span class="n">XX_pk_krig</span><span class="p">,</span> <span class="n">YY_pk_krig</span><span class="p">)</span>

<span class="c1"># Export raster</span>
<span class="n">export_kde_raster</span><span class="p">(</span><span class="n">Z</span> <span class="o">=</span> <span class="n">Z_pk_krig</span><span class="p">,</span> <span class="n">XX</span> <span class="o">=</span> <span class="n">XX_pk_krig</span><span class="p">,</span> <span class="n">YY</span> <span class="o">=</span> <span class="n">YY_pk_krig</span><span class="p">,</span>
                  <span class="n">min_x</span> <span class="o">=</span> <span class="n">min_x_rain</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">max_x_rain</span><span class="p">,</span> <span class="n">min_y</span> <span class="o">=</span> <span class="n">min_y_rain</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">max_y_rain</span><span class="p">,</span>
                  <span class="n">proj</span> <span class="o">=</span> <span class="n">proj</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;../temp/e_bay-area-rain_pk_kriging.tif&quot;</span><span class="p">)</span>

<span class="c1"># Open raster</span>
<span class="n">raster_pk</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;../temp/e_bay-area-rain_pk_kriging.tif&quot;</span><span class="p">)</span>


<span class="c1"># Create polygon with extent of raster</span>
<span class="n">poly_shapely</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="o">*</span><span class="n">raster_pk</span><span class="o">.</span><span class="n">bounds</span><span class="p">)</span>

<span class="c1"># Create a dictionary with needed attributes and required geometry column</span>
<span class="n">attributes_df</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Attribute&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;name1&#39;</span><span class="p">],</span> <span class="s1">&#39;geometry&#39;</span><span class="p">:</span> <span class="n">poly_shapely</span><span class="p">}</span>

<span class="c1"># Convert shapely object to a GeoDataFrame</span>
<span class="n">raster_pk_extent</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">attributes_df</span><span class="p">,</span> <span class="n">geometry</span> <span class="o">=</span> <span class="s1">&#39;geometry&#39;</span><span class="p">,</span> <span class="n">crs</span> <span class="o">=</span> <span class="n">proj</span><span class="p">)</span>

<span class="c1"># Create copy of test dataset</span>
<span class="n">rain_test_gdf_pk_krig</span> <span class="o">=</span> <span class="n">rain_test_gdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># Subset the GeoDataFrame by checking which test points are within the raster extent polygon</span>
<span class="c1"># If a test point is beyond the extent of training points dataset, the kriging output may not cover that test point</span>
<span class="n">rain_test_gdf_pk_krig</span> <span class="o">=</span> <span class="n">rain_test_gdf_pk_krig</span><span class="p">[</span><span class="n">rain_test_gdf_pk_krig</span><span class="o">.</span><span class="n">within</span><span class="p">(</span><span class="n">raster_pk_extent</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

<span class="c1"># Create list of XY coordinate pairs for the test points that fall within raster extent polygon</span>
<span class="n">coords_rain_test_pk_krig</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span> <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rain_test_gdf_pk_krig</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">rain_test_gdf_pk_krig</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">)]</span>

<span class="c1"># Extract raster value at each test point and add the values to the GeoDataFrame</span>
<span class="n">rain_test_gdf_pk_krig</span><span class="p">[</span><span class="s2">&quot;VALUE_Predict&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raster_pk</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">coords_rain_test_pk_krig</span><span class="p">)]</span>

<span class="c1"># Generate out-of-sample R^2</span>
<span class="n">out_r_squared_tp</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">rain_test_gdf_pk_krig</span><span class="o">.</span><span class="n">Actual_Value</span><span class="p">,</span> <span class="n">rain_test_gdf_pk_krig</span><span class="o">.</span><span class="n">VALUE_Predict</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PyKrige Kriging out-of-sample r-squared: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">out_r_squared_tp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

<span class="c1"># Display attribute table</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Attribute Table: Random Points Interpolated Values - PyKrige Kriging Method&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">rain_test_gdf_pk_krig</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>


<span class="c1"># Mask raster to counties shape</span>
<span class="n">out_image_pk</span><span class="p">,</span> <span class="n">out_transform_pk</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">raster_pk</span><span class="p">,</span> <span class="n">counties</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">crop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Stylize plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;bmh&#39;</span><span class="p">)</span>

<span class="c1"># Plot data</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">show</span><span class="p">(</span><span class="n">out_image_pk</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">out_transform_pk</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;RdPu&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_rain</span><span class="p">,</span> <span class="n">y_rain</span><span class="p">,</span> <span class="s1">&#39;k.&#39;</span><span class="p">,</span> <span class="n">markersize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">counties</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">&#39;dimgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

<span class="c1"># Set title</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;San Francisco Bay Area - Interpolating Rainfall using Kriging from PyKrige&#39;</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fontsize&#39;</span><span class="p">:</span> <span class="s1">&#39;15&#39;</span><span class="p">,</span> <span class="s1">&#39;fontweight&#39;</span> <span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">})</span>

<span class="c1"># Display plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="method-2-using-scikit-learn">
<h3>Method 2- Using <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code><a class="headerlink" href="#method-2-using-scikit-learn" title="Link to this heading">#</a></h3>
<p>Kriging can be performed using <a class="reference external" href="https://scikit-learn.org/stable/modules/gaussian_process.html">Gaussian processes from the <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> module</a> (Gaussian processes is essentially equivalent to kriging). Various kernels for Gaussian processes can be specified. We will continue to use the training and testing datasets created from our KNN analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Create a 100 by 100 cell mesh grid</span>
<span class="sd"># Horizontal and vertical cell counts should be the same</span>
<span class="sd">XX_sk_krig, YY_sk_krig = np.mgrid[min_x_rain_wgs:max_x_rain_wgs:100j, min_y_rain_wgs:max_y_rain_wgs:100j]</span>

<span class="sd"># Create 2-D array of the coordinates (paired) of each cell in the mesh grid</span>
<span class="sd">positions_sk_krig = np.vstack([XX_sk_krig.ravel(), YY_sk_krig.ravel()]).T</span>

<span class="sd"># Generate Gaussian Process model (can change parameters as desired)</span>
<span class="sd">gp = GaussianProcessRegressor(n_restarts_optimizer = 10)</span>

<span class="sd"># Fit kernel density estimator to coordinates and values</span>
<span class="sd">gp.fit(coords_rain_train_wgs, value_rain_train)</span>

<span class="sd"># Evaluate the model on coordinate pairs</span>
<span class="sd">Z_sk_krig = gp.predict(positions_sk_krig)</span>

<span class="sd"># Reshape the data to fit mesh grid</span>
<span class="sd">Z_sk_krig = Z_sk_krig.reshape(XX_sk_krig.shape)</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we can calculate our r-squared statistics and predictions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Generate in-sample R^2</span>
<span class="sd">in_r_squared_sk_krig = gp.score(coords_rain_train_wgs, value_rain_train)</span>
<span class="sd">print(&quot;Scikit-Learn Kriging in-sample r-squared: {}&quot;.format(round(in_r_squared_sk_krig, 2)))</span>

<span class="sd"># Generate out-of-sample R^2</span>
<span class="sd">out_r_squared_sk_krig = gp.score(coords_rain_test_wgs, value_rain_test)</span>
<span class="sd">print(&quot;Scikit-Learn Kriging out-of-sample r-squared: {}&quot;.format(round(out_r_squared_sk_krig, 2)))</span>

<span class="sd"># Predict values for testing dataset</span>
<span class="sd">coords_rain_test_predict_sk_krig = gp.predict(coords_rain_test_wgs)</span>

<span class="sd"># Create dictionary holding the actual and predicted values</span>
<span class="sd">predict_dict_sk_krig = {&quot;Coordinate_Pair&quot;: coords_rain_test_wgs, &quot;VALUE_Actual&quot;: value_rain_test, &quot;VALUE_Predict&quot;: coords_rain_test_predict_sk_krig}</span>

<span class="sd"># Create dataframe from dictionary</span>
<span class="sd">predict_df_sk_krig = pd.DataFrame(predict_dict_sk_krig)</span>

<span class="sd"># Display attribute table</span>
<span class="sd">print(&quot;\nAttribute Table: Testing Set Interpolated Values - Scikit-Learn Kriging Method&quot;)</span>
<span class="sd">display(predict_df_sk_krig.head(2))</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Model seems like a good fit! Let’s export the raster.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Flip array vertically and rotate 270 degrees</span>
<span class="sd">Z_sk_krig = np.rot90(np.flip(Z_sk_krig, 0), 3)</span>

<span class="sd"># Export raster</span>
<span class="sd">export_kde_raster(Z = Z_sk_krig, XX = XX_sk_krig, YY = YY_sk_krig,</span>
<span class="sd">                  min_x = min_x_rain_wgs, max_x = max_x_rain_wgs, min_y = min_y_rain_wgs, max_y = max_y_rain_wgs,</span>
<span class="sd">                  proj = proj_wgs, filename = ../temp/e_bay-area-rain_sk_kriging.tif&quot;)</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The resulting raster should be clipped. Because the resulting raster covers the extent of the points in a bounding box fashion, the raster in this case covers areas that are not within the counties boundaries (such as in the ocean) where we do not have sample points. Thus, there will be interpolated values in those areas that might not make sense.</p>
</div>
<p>Finally, we import the raster, mask it to the counties boundaries, and plot the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Open raster</span>
<span class="sd">raster_sk = rasterio.open(&quot;../temp/e_bay-area-rain_sk_kriging.tif&quot;)</span>

<span class="sd"># Mask raster to counties shape</span>
<span class="sd">out_image_sk, out_transform_sk = rasterio.mask.mask(raster_sk, counties_wgs.geometry.values, crop = True)</span>

<span class="sd"># Stylize plots</span>
<span class="sd">plt.style.use(&#39;bmh&#39;)</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id7">
<h3>Method 2- Using <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code><a class="headerlink" href="#id7" title="Link to this heading">#</a></h3>
<p>Kriging can be performed using <a class="reference external" href="https://scikit-learn.org/stable/modules/gaussian_process.html">Gaussian processes from the <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code> module</a> (Gaussian processes is essentially equivalent to kriging). Various kernels for Gaussian processes can be specified. We will continue to use the training and testing datasets created from our KNN analysis.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Create a 100 by 100 cell mesh grid</span>
<span class="sd"># Horizontal and vertical cell counts should be the same</span>
<span class="sd">XX_sk_krig, YY_sk_krig = np.mgrid[min_x_rain_wgs:max_x_rain_wgs:100j, min_y_rain_wgs:max_y_rain_wgs:100j]</span>

<span class="sd"># Create 2-D array of the coordinates (paired) of each cell in the mesh grid</span>
<span class="sd">positions_sk_krig = np.vstack([XX_sk_krig.ravel(), YY_sk_krig.ravel()]).T</span>

<span class="sd"># Generate Gaussian Process model (can change parameters as desired)</span>
<span class="sd">gp = GaussianProcessRegressor(n_restarts_optimizer = 10)</span>

<span class="sd"># Fit kernel density estimator to coordinates and values</span>
<span class="sd">gp.fit(coords_rain_train_wgs, value_rain_train)</span>

<span class="sd"># Evaluate the model on coordinate pairs</span>
<span class="sd">Z_sk_krig = gp.predict(positions_sk_krig)</span>

<span class="sd"># Reshape the data to fit mesh grid</span>
<span class="sd">Z_sk_krig = Z_sk_krig.reshape(XX_sk_krig.shape)</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we can calculate our r-squared statistics and predictions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Generate in-sample R^2</span>
<span class="sd">in_r_squared_sk_krig = gp.score(coords_rain_train_wgs, value_rain_train)</span>
<span class="sd">print(&quot;Scikit-Learn Kriging in-sample r-squared: {}&quot;.format(round(in_r_squared_sk_krig, 2)))</span>

<span class="sd"># Generate out-of-sample R^2</span>
<span class="sd">out_r_squared_sk_krig = gp.score(coords_rain_test_wgs, value_rain_test)</span>
<span class="sd">print(&quot;Scikit-Learn Kriging out-of-sample r-squared: {}&quot;.format(round(out_r_squared_sk_krig, 2)))</span>

<span class="sd"># Predict values for testing dataset</span>
<span class="sd">coords_rain_test_predict_sk_krig = gp.predict(coords_rain_test_wgs)</span>

<span class="sd"># Create dictionary holding the actual and predicted values</span>
<span class="sd">predict_dict_sk_krig = {&quot;Coordinate_Pair&quot;: coords_rain_test_wgs, &quot;VALUE_Actual&quot;: value_rain_test, &quot;VALUE_Predict&quot;: coords_rain_test_predict_sk_krig}</span>

<span class="sd"># Create dataframe from dictionary</span>
<span class="sd">predict_df_sk_krig = pd.DataFrame(predict_dict_sk_krig)</span>

<span class="sd"># Display attribute table</span>
<span class="sd">print(&quot;\nAttribute Table: Testing Set Interpolated Values - Scikit-Learn Kriging Method&quot;)</span>
<span class="sd">display(predict_df_sk_krig.head(2))</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Model seems like a good fit! Let’s export the raster.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Flip array vertically and rotate 270 degrees</span>
<span class="sd">Z_sk_krig = np.rot90(np.flip(Z_sk_krig, 0), 3)</span>

<span class="sd"># Export raster</span>
<span class="sd">export_kde_raster(Z = Z_sk_krig, XX = XX_sk_krig, YY = YY_sk_krig,</span>
<span class="sd">                  min_x = min_x_rain_wgs, max_x = max_x_rain_wgs, min_y = min_y_rain_wgs, max_y = max_y_rain_wgs,</span>
<span class="sd">                  proj = proj_wgs, filename = ../temp/e_bay-area-rain_sk_kriging.tif&quot;)</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The resulting raster should be clipped. Because the resulting raster covers the extent of the points in a bounding box fashion, the raster in this case covers areas that are not within the counties boundaries (such as in the ocean) where we do not have sample points. Thus, there will be interpolated values in those areas that might not make sense.</p>
</div>
<p>Finally, we import the raster, mask it to the counties boundaries, and plot the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># Open raster</span>
<span class="sd">raster_sk = rasterio.open(&quot;../temp/e_bay-area-rain_sk_kriging.tif&quot;)</span>

<span class="sd"># Mask raster to counties shape</span>
<span class="sd">out_image_sk, out_transform_sk = rasterio.mask.mask(raster_sk, counties_wgs.geometry.values, crop = True)</span>

<span class="sd"># Stylize plots</span>
<span class="sd">plt.style.use(&#39;bmh&#39;)</span>

<span class="sd"># Plot data</span>
<span class="sd">fig, ax = plt.subplots(1, figsize = (10, 10))</span>
<span class="sd">show(out_image_sk, ax = ax, transform = out_transform_sk, cmap = &quot;RdPu&quot;)</span>
<span class="sd">ax.plot(x_rain_wgs, y_rain_wgs, &#39;k.&#39;, markersize = 2, alpha = 0.5)</span>
<span class="sd">counties_wgs.plot(ax = ax, color = &#39;none&#39;, edgecolor = &#39;dimgray&#39;)</span>
<span class="sd">plt.gca().invert_yaxis()</span>

<span class="sd"># Set title</span>
<span class="sd">ax.set_title(&#39;San Francisco Bay Area - Interpolating Rainfall using Kriging from Scikit-Learn&#39;, fontdict = {&#39;fontsize&#39;: &#39;15&#39;, &#39;fontweight&#39; : &#39;3&#39;})</span>

<span class="sd"># Display plot</span>
<span class="sd">plt.show()</span>


<span class="sd"># Plot data</span>
<span class="sd">fig, ax = plt.subplots(1, figsize = (10, 10))</span>
<span class="sd">show(out_image_sk, ax = ax, transform = out_transform_sk, cmap = &quot;RdPu&quot;)</span>
<span class="sd">ax.plot(x_rain_wgs, y_rain_wgs, &#39;k.&#39;, markersize = 2, alpha = 0.5)</span>
<span class="sd">counties_wgs.plot(ax = ax, color = &#39;none&#39;, edgecolor = &#39;dimgray&#39;)</span>
<span class="sd">plt.gca().invert_yaxis()</span>

<span class="sd"># Set title</span>
<span class="sd">ax.set_title(&#39;San Francisco Bay Area - Interpolating Rainfall using Kriging from Scikit-Learn&#39;, fontdict = {&#39;fontsize&#39;: &#39;15&#39;, &#39;fontweight&#39; : &#39;3&#39;})</span>

<span class="sd"># Display plot</span>
<span class="sd">plt.show()</span>
<span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</div>
</div>
<hr class="footnotes docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="bolstad" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id1">1</a>,<a role="doc-backlink" href="#id2">2</a>,<a role="doc-backlink" href="#id5">3</a>)</span>
<p>GIS Fundamentals: A First Text on Geographic Information Systems, 5th ed., Paul Bolstad</p>
</aside>
<aside class="footnote brackets" id="scipy-voronoi" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">2</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.spatial.Voronoi.html">scipy.spatial.Voronoi, SciPy</a></p>
</aside>
<aside class="footnote brackets" id="sk-nn" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">3</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://scikit-learn.org/stable/modules/neighbors.html">Nearest Neighbors, scikit-learn</a></p>
</aside>
<aside class="footnote brackets" id="esri-kriging" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">4</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://pro.arcgis.com/en/pro-app/latest/tool-reference/3d-analyst/how-kriging-works.htm">How Kriging works, Esri</a></p>
</aside>
</aside>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="e_summarize_vector.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Point Density Measures - Counts &amp; Kernel Density</p>
      </div>
    </a>
    <a class="right-next"
       href="e_new_rasters.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Reading &amp; Writing Rasters with Rasterio</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#thiessen-polygons-voronoi-diagrams">Thiessen Polygons (Voronoi Diagrams)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#k-nearest-neighbors">K-Nearest Neighbors</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kriging">Kriging</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#method-1-using-pykrige">Method 1 - Using <code class="docutils literal notranslate"><span class="pre">PyKrige</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#method-2-using-scikit-learn">Method 2- Using <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Method 2- Using <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code></a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Michael Mann, Steven Chao, Jordan Graesser, Nina Feldman
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>
    <b>Supported by:</b>  <br>
    <a href="https://geography.columbian.gwu.edu/">
 <img alt="GW Geography" src="../_static/global/GWBlue.png"
  width="300" align="left">
</div>
<div>
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" ><img align="right" alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a> 
</div><br><br>
<div>
<a rel="Reference" href="https://zenodo.org/badge/latestdoi/344683467" ><img align="right" alt="Reference our work" style="border-width:0" src="https://zenodo.org/badge/344683467.svg" /></a> 
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>